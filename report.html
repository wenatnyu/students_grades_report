<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <img src="logo.png" alt="Logo" class="logo-centered">
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Students List</a>
        
        <div class="header">
            <div class="student-info">
                <h1 id="studentName">Student Name</h1>
                <div class="student-details" id="studentDetails">ID: <span id="studentId"></span></div>
                <div class="student-details">Courses: <span id="subjectCount"></span></div>
            </div>
            <div class="gpa-display">
                GPA: <span id="studentGPA"></span>
            </div>
        </div>
        
        <table class="subjects-table">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Score</th>
                    <th>Grade</th>
                    <th>GPA Point</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody id="subjectsTableBody">
            </tbody>
        </table>
        
        <div class="chart-container">
            <div class="chart-title">Radar Chart - Student Ability vs Average</div>
            <canvas id="radarChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Pie Chart - Subject Scores Proportion</div>
            <canvas id="pieChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Bar Chart - Score Distribution vs Average</div>
            <canvas id="barChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Doughnut Chart - Subject Scores Proportion</div>
            <canvas id="doughnutChart"></canvas>
        </div>
        
        <div class="download-buttons">
            <button class="download-btn" id="downloadPDF">Download PDF</button>
            <button class="download-btn" id="downloadImage">Download Image</button>
        </div>
    </div>

    <script>
        // Load student data from localStorage
        const student = JSON.parse(localStorage.getItem('currentStudent'));
        const subjectAverages = JSON.parse(localStorage.getItem('subjectAverages'));
        const studentsData = JSON.parse(localStorage.getItem('studentsData'));
        
        if (!student) {
            window.location.href = 'index.html';
        }
        
        // Display student info
        document.getElementById('studentName').textContent = `${student.chineseName} (${student.englishName})`;
        document.getElementById('studentId').textContent = student.id;
        document.getElementById('studentGPA').textContent = calculateGPA(student.subjects);
        document.getElementById('subjectCount').textContent = student.subjects.length;
        
        // Display subjects table
        const subjectsTableBody = document.getElementById('subjectsTableBody');
        student.subjects.forEach(subject => {
            const row = document.createElement('tr');
            const comment = subject.comment && subject.comment.trim() !== '' ? 
                subject.comment : 
                generateComment(subject.score, subject.grade);
            
            // Use bilingual name if available, otherwise use regular name
            const displayName = subject.bilingualName || subject.name;
            
            row.innerHTML = `
                <td>${displayName}</td>
                <td>${subject.score}</td>
                <td><span class="grade-badge grade-${subject.grade}">${subject.grade}</span></td>
                <td>${subject.gpaPoint}</td>
                <td>${comment}</td>
            `;
            subjectsTableBody.appendChild(row);
        });
        
        // Sort subjects by score (low to high) for bar chart
        const sortedSubjects = [...student.subjects].sort((a, b) => a.score - b.score);
        
        // Prepare data for charts
        const subjectNames = sortedSubjects.map(s => s.bilingualName || s.name);
        const studentScores = sortedSubjects.map(s => s.score);
        const averageScores = sortedSubjects.map(s => subjectAverages[s.name]);
        
        // Colors for charts
        const backgroundColors = [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)',
            'rgba(83, 102, 255, 0.7)',
            'rgba(255, 99, 255, 0.7)',
            'rgba(99, 255, 132, 0.7)'
        ];
        
        const borderColors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)',
            'rgba(83, 102, 255, 1)',
            'rgba(255, 99, 255, 1)',
            'rgba(99, 255, 132, 1)'
        ];
        
        // Radar Chart
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: subjectNames,
                datasets: [{
                    label: 'Student Score',
                    data: studentScores,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }, {
                    label: 'Average Score',
                    data: averageScores,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    r: {
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
        
        // Pie Chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: subjectNames,
                datasets: [{
                    data: studentScores,
                    backgroundColor: backgroundColors.slice(0, subjectNames.length),
                    borderColor: borderColors.slice(0, subjectNames.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
        
        // Bar Chart
        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: subjectNames,
                datasets: [{
                    label: 'Student Score',
                    data: studentScores,
                    backgroundColor: backgroundColors.slice(0, subjectNames.length),
                    borderColor: borderColors.slice(0, subjectNames.length),
                    borderWidth: 1
                }, {
                    label: 'Average Score',
                    data: averageScores,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
        
        // Doughnut Chart
        const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
        new Chart(doughnutCtx, {
            type: 'doughnut',
            data: {
                labels: subjectNames,
                datasets: [{
                    data: studentScores,
                    backgroundColor: backgroundColors.slice(0, subjectNames.length),
                    borderColor: borderColors.slice(0, subjectNames.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
        
        // Download functionality
        document.getElementById('downloadPDF').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            
            // Improve performance by setting proper styles during capture
            const container = document.querySelector('.container');
            const originalBodyOverflow = document.body.style.overflow;
            const originalContainerOverflow = container.style.overflow;
            const originalPosition = container.style.position;
            const originalWidth = container.style.width;
            
            // Optimize for capture
            document.body.style.overflow = 'visible';
            container.style.overflow = 'visible';
            container.style.position = 'relative';
            container.style.width = '1000px'; // Set fixed width for consistent capture
            
            html2canvas(container, {
                useCORS: true,
                allowTaint: true,
                scale: 1.5, // Moderate scale for quality without excessive size
                width: container.scrollWidth,
                height: container.scrollHeight,
                willReadFrequently: true, // Address the performance warning
                onclone: function(clonedDoc) {
                    // Ensure cloned document has proper styling
                    clonedDoc.body.style.overflow = 'visible';
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.8); // Use JPEG for smaller file size
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Restore original styles
                document.body.style.overflow = originalBodyOverflow;
                container.style.overflow = originalContainerOverflow;
                container.style.position = originalPosition;
                container.style.width = originalWidth;
                
                doc.save(`${student.englishName}_Report.pdf`);
            }).catch(error => {
                console.error('Error generating PDF:', error);
                // Restore original styles even if there's an error
                document.body.style.overflow = originalBodyOverflow;
                container.style.overflow = originalContainerOverflow;
                container.style.position = originalPosition;
                container.style.width = originalWidth;
                alert('Error generating PDF. Please try again.');
            });
        });
        
        document.getElementById('downloadImage').addEventListener('click', function() {
            const container = document.querySelector('.container');
            const originalBodyOverflow = document.body.style.overflow;
            const originalContainerOverflow = container.style.overflow;
            const originalPosition = container.style.position;
            const originalWidth = container.style.width;
            
            // Optimize for capture
            document.body.style.overflow = 'visible';
            container.style.overflow = 'visible';
            container.style.position = 'relative';
            container.style.width = '1000px';
            
            html2canvas(container, {
                useCORS: true,
                allowTaint: true,
                scale: 2, // Higher scale for image quality
                width: container.scrollWidth,
                height: container.scrollHeight,
                willReadFrequently: true, // Address the performance warning
                onclone: function(clonedDoc) {
                    clonedDoc.body.style.overflow = 'visible';
                }
            }).then(canvas => {
                // Restore original styles
                document.body.style.overflow = originalBodyOverflow;
                container.style.overflow = originalContainerOverflow;
                container.style.position = originalPosition;
                container.style.width = originalWidth;
                
                const link = document.createElement('a');
                link.download = `${student.englishName}_Report.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error('Error generating image:', error);
                // Restore original styles even if there's an error
                document.body.style.overflow = originalBodyOverflow;
                container.style.overflow = originalContainerOverflow;
                container.style.position = originalPosition;
                container.style.width = originalWidth;
                alert('Error generating image. Please try again.');
            });
        });
        
        // Calculate GPA based on subject GPA points
        function calculateGPA(subjects) {
            if (subjects.length === 0) return 'N/A';
            const totalPoints = subjects.reduce((sum, subject) => sum + subject.gpaPoint, 0);
            return (totalPoints / subjects.length).toFixed(2);
        }
        
        // Generate a simple comment based on score and grade
        function generateComment(score, grade) {
            if (score >= 90) {
                return "Excellent performance, keep it up";
            } else if (score >= 80) {
                return "Good performance, there's room for improvement";
            } else if (score >= 70) {
                return "Average performance, need to work harder";
            } else if (score >= 60) {
                return "Poor performance, needs attention";
            } else {
                return "Very poor performance, needs extra help";
            }
        }
    </script>
</body>
</html>